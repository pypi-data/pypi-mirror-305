(function(g,s){typeof exports=="object"&&typeof module<"u"?s(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],s):(g=typeof globalThis<"u"?globalThis:g||self,s(g.trame_annotations={},g.Vue))})(this,function(g,s){"use strict";class C{constructor(e,n=0){this.bounds={x:e.x||0,y:e.y||0,width:e.width,height:e.height},this.maxObjects=typeof e.maxObjects=="number"?e.maxObjects:10,this.maxLevels=typeof e.maxLevels=="number"?e.maxLevels:4,this.level=n,this.objects=[],this.nodes=[]}getIndex(e){return e.qtIndex(this.bounds)}split(){const e=this.level+1,n=this.bounds.width/2,i=this.bounds.height/2,o=this.bounds.x,u=this.bounds.y,c=[{x:o+n,y:u},{x:o,y:u},{x:o,y:u+i},{x:o+n,y:u+i}];for(let a=0;a<4;a++)this.nodes[a]=new C({x:c[a].x,y:c[a].y,width:n,height:i,maxObjects:this.maxObjects,maxLevels:this.maxLevels},e)}insert(e){if(this.nodes.length){const n=this.getIndex(e);for(let i=0;i<n.length;i++)this.nodes[n[i]].insert(e);return}if(this.objects.push(e),this.objects.length>this.maxObjects&&this.level<this.maxLevels){this.nodes.length||this.split();for(let n=0;n<this.objects.length;n++){const i=this.getIndex(this.objects[n]);for(let o=0;o<i.length;o++)this.nodes[i[o]].insert(this.objects[n])}this.objects=[]}}retrieve(e){const n=this.getIndex(e);let i=this.objects;if(this.nodes.length)for(let o=0;o<n.length;o++)i=i.concat(this.nodes[n[o]].retrieve(e));return this.level===0?Array.from(new Set(i)):i}remove(e,n=!1){const i=this.objects.indexOf(e);i>-1&&this.objects.splice(i,1);for(let o=0;o<this.nodes.length;o++)this.nodes[o].remove(e);return this.level===0&&!n&&this.join(),i!==-1}update(e,n=!1){this.remove(e,n),this.insert(e)}join(){let e=Array.from(this.objects);for(let i=0;i<this.nodes.length;i++){const o=this.nodes[i].join();e=e.concat(o)}const n=Array.from(new Set(e));if(n.length<=this.maxObjects){this.objects=n;for(let i=0;i<this.nodes.length;i++)this.nodes[i].objects=[];this.nodes=[]}return e}clear(){this.objects=[];for(let e=0;e<this.nodes.length;e++)this.nodes.length&&this.nodes[e].clear();this.nodes=[]}}class k{constructor(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this.data=e.data}qtIndex(e){const n=[],i=e.x+e.width/2,o=e.y+e.height/2,u=this.y<o,c=this.x<i,a=this.x+this.width>i,x=this.y+this.height>o;return u&&a&&n.push(0),c&&u&&n.push(1),c&&x&&n.push(2),a&&x&&n.push(3),n}}const B={style:{position:"relative"}},F=["src"],G=.9,A=2,L=12,T={ImageDetection:s.defineComponent({__name:"ImageDetection",props:{identifier:{},src:{},annotations:{},categories:{},selected:{type:Boolean},containerSelector:{}},emits:["hover"],setup(y,{emit:e}){const n=[[255,0,0],[0,255,0],[0,0,255],[255,255,0],[255,0,255],[0,255,255]],i=[8,8];let o;function u(t,l){return l.x>=t.x+t.width||t.x>=l.x+l.width?!1:!(l.y>=t.y+t.height||t.y>=l.y+l.height)}const c=y,a=s.ref(),x=s.computed(()=>{var t;return(t=a.value)==null?void 0:t.getContext("2d",{alpha:!0})}),f=s.ref(),I=s.computed(()=>{var t;return(t=f.value)==null?void 0:t.getContext("2d",{willReadFrequently:!0})}),d=s.ref(),m=s.ref({width:0,height:0}),_=s.ref(),K=()=>{var t,l;m.value={width:((t=_.value)==null?void 0:t.naturalWidth)??0,height:((l=_.value)==null?void 0:l.naturalHeight)??0}},N=s.computed(()=>s.unref(c.annotations)??[]),V=s.computed(()=>N.value.map(t=>{const l=t.category_id??0,h=n[l%n.length];return{...t,color:h}}));s.watchEffect(()=>{if(!a.value||!x.value)return;const t=a.value,l=x.value;t.width=m.value.width,t.height=m.value.height,l.clearRect(0,0,t.width,t.height),l.lineWidth=A,V.value.forEach(({color:h,bbox:r})=>{l.strokeStyle=`rgba(${[...h,G].join(",")})`,l.strokeRect(r[0],r[1],r[2],r[3])})}),s.watchEffect(()=>{if(!I.value||!f.value)return;const t=f.value,l=I.value;t.width=m.value.width,t.height=m.value.height,l.clearRect(0,0,t.width,t.height),o=new C({width:t.width,height:t.height,maxLevels:8,maxObjects:10}),N.value.forEach((h,r)=>{const p=new k({x:h.bbox[0],y:h.bbox[1],width:h.bbox[2],height:h.bbox[3],data:r});o==null||o.insert(p),l.fillStyle="rgb(255, 0, 0)",l.fillRect(h.bbox[0],h.bbox[1],h.bbox[2],h.bbox[3])})});const Y=e;function M(){d.value&&(d.value.style.visibility="hidden")}s.onMounted(M);function Q(){Y("hover",{id:c.identifier})}function U(){Y("hover",{id:""}),M()}function Z(t,l,h){const r=h.getBoundingClientRect(),p=h.width*(t-r.left)/r.width,$=h.height*(l-r.top)/r.height;return[p,$]}const W=s.ref(!1);s.onMounted(()=>{W.value=!0});const ee=s.computed(()=>!W.value||!c.containerSelector?null:document.querySelector(c.containerSelector));function te(t){var z;if(!f.value||f.value.width===0||!d.value||!o||!c.categories||!c.annotations)return;const l=I.value;if(!l)return;const[h,r]=Z(t.clientX,t.clientY,f.value);if(!(l.getImageData(h,r,1,1).data[0]>0)){d.value.style.visibility="hidden";return}d.value.style.visibility="visible";const q=new k({x:h,y:r,width:2,height:2}),se=o.retrieve(q).filter(b=>u(b,q)).filter(b=>b.data!=null).map(b=>{var H;const v=V.value[b.data],oe=((H=c.categories[v.category_id])==null?void 0:H.name)??v.label,le=v.color,R=document.createElement("li");R.style.textShadow=`rgba(${le.join(",")},0.6) 1px 1px 3px`;const he=v.id?` : ${v.id}`:"";return R.textContent=`${oe}${he}`,R});d.value.replaceChildren(...se);const[D,P]=[t.offsetX,t.offsetY];let S=D+i[0],E=P+i[1];const w=d.value.getBoundingClientRect(),X=f.value.getBoundingClientRect(),O=((z=ee.value)==null?void 0:z.getBoundingClientRect())??{left:0,top:0,width:window.innerWidth,height:window.innerHeight},j={left:X.left+S-O.left,top:X.top+E-O.top,width:w.width+L,height:w.height+L};j.left+j.width>O.width&&(S=D-w.width-i[0]),j.top+j.height>O.height&&(E=P-w.height-i[1]),d.value.style.left=`${S}px`,d.value.style.top=`${E}px`}const ie=s.computed(()=>c.selected?"4":"0"),ne=s.computed(()=>s.unref(c.src));return(t,l)=>(s.openBlock(),s.createElementBlock("div",B,[s.createElementVNode("img",{ref_key:"img",ref:_,src:ne.value,style:s.normalizeStyle([{outlineWidth:ie.value+"px"},{width:"100%","outline-style":"dotted","outline-color":"red"}]),onLoad:K},null,44,F),s.createElementVNode("canvas",{ref_key:"visibleCanvas",ref:a,style:{width:"100%",position:"absolute",left:"0",top:"0"}},null,512),s.createElementVNode("canvas",{ref_key:"pickingCanvas",ref:f,style:{opacity:"0",width:"100%",position:"absolute",left:"0",top:"0"},onMouseenter:Q,onMousemove:te,onMouseleave:U},null,544),s.createElementVNode("ul",{ref_key:"labelContainer",ref:d,style:{position:"absolute","z-index":"10",padding:"0.4rem","white-space":"pre","font-size":"small","border-radius":"0.2rem","border-color":"rgba(127, 127, 127, 0.75)","border-style":"solid","border-width":"thin","background-color":"#efefef","list-style-type":"none"}},null,512)]))}})};function J(y){Object.keys(T).forEach(e=>{y.component(e,T[e])})}g.install=J,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=trame_annotations.umd.cjs.map
