"use strict";(self.webpackChunkfirebird=self.webpackChunkfirebird||[]).push([[1039],{1039:($,C,l)=>{l.r(C),l.d(C,{SceneTreeComponent:()=>A});var b=l(7358),E=l(4109),_=l(9213),R=l(8834),S=l(3973),v=l(3137),s=l(4823),t=l(4438),D=l(1632),I=l(3709);function x(N,L){if(1&N){const n=t.RV6();t.j41(0,"mat-tree-node",6),t.nrm(1,"button",7),t.EFF(2),t.j41(3,"button",8),t.bIt("click",function(){const r=t.eBV(n).$implicit,p=t.XpG();return t.Njj(p.toggleVisibility(r))}),t.j41(4,"mat-icon"),t.EFF(5),t.k0s()()()}if(2&N){const n=L.$implicit;t.R7$(2),t.SpI(" ",n.name," "),t.R7$(3),t.JRh(n.visible?"visibility":"visibility_off")}}function u(N,L){if(1&N){const n=t.RV6();t.j41(0,"mat-tree-node",9),t.bIt("mouseenter",function(){const r=t.eBV(n).$implicit,p=t.XpG();return t.Njj(p.highlightNode(r))})("mouseleave",function(){const r=t.eBV(n).$implicit,p=t.XpG();return t.Njj(p.unhighlightElement(r))}),t.j41(1,"button",10)(2,"mat-icon",11),t.EFF(3),t.k0s()(),t.EFF(4),t.j41(5,"button",8),t.bIt("click",function(){const r=t.eBV(n).$implicit,p=t.XpG();return t.Njj(p.toggleVisibility(r))}),t.j41(6,"mat-icon"),t.EFF(7),t.k0s()()()}if(2&N){const n=L.$implicit,c=t.XpG();t.R7$(),t.BMQ("aria-label","Toggle "+n.name),t.R7$(2),t.SpI(" ",c.treeControl.isExpanded(n)?"expand_more":"chevron_right"," "),t.R7$(),t.SpI(" ",n.name," "),t.R7$(3),t.JRh(n.visible?"visibility":"visibility_off")}}let A=(()=>{class N{constructor(n,c){this.geomService=n,this.eventDisplay=c,this.isHighlightingEnabled=!1,this._transformer=(r,p)=>({expandable:!!r.children&&r.children.length>0,name:r.name,level:p,type:r.type,object3D:r,visible:r.visible}),this.treeControl=new E.XW(r=>r.level,r=>r.expandable),this.treeFlattener=new b.yj(this._transformer,r=>r.level,r=>r.expandable,r=>r.children),this.dataSource=new b.zw(this.treeControl,this.treeFlattener),this.hasChild=(r,p)=>p.expandable,this.threeFacade=new v.c(this.eventDisplay)}ngOnInit(){this.dataSource.data=this.threeFacade.scene.children}toggleVisibility(n){this.geomService.toggleVisibility(n.object3D),n.visible=!n.visible}refreshScheneTree(){this.dataSource.data=[],this.dataSource.data=this.threeFacade.scene.children}toggleHighlighting(){this.isHighlightingEnabled=!this.isHighlightingEnabled,console.log("Highlighting is now "+(this.isHighlightingEnabled?"enabled":"disabled"))}isEventDataNode(n){let c=n;for(;c;){if(c.name.includes("EventData"))return!0;c=this.getParentNode(c)}return!1}getParentNode(n){for(let c=0;c<this.treeControl.dataNodes.length;c++){const r=this.treeControl.dataNodes[c];if(r.expandable&&this.treeControl.getLevel(r)<n.level&&this.treeControl.getDescendants(r).includes(n))return r}return null}highlightNode(n){if(!this.isHighlightingEnabled)return;const c=this.isEventDataNode(n);n.object3D.traverse(r=>{if(r instanceof S.eaF)if(r.userData.originalMaterial||(r.userData.originalMaterial=r.material),c){const F=r.material.clone();F.color.set(16776960),F.wireframe=!0,r.material=F}else r.material=new S.V9B({color:16776960,wireframe:!0})}),console.log(`Element highlighted: ${n.name}`)}unhighlightElement(n){this.isHighlightingEnabled&&(n.object3D.traverse(c=>{c instanceof S.eaF&&c.userData.originalMaterial&&(c.material=c.userData.originalMaterial)}),console.log(`Element unhighlighted: ${n.name}`))}static{this.\u0275fac=function(c){return new(c||N)(t.rXU(D.Ab),t.rXU(I.Oz))}}static{this.\u0275cmp=t.VBU({type:N,selectors:[["app-geometry-tree"]],standalone:!0,features:[t.aNF],decls:10,vars:4,consts:[[1,"header"],["mat-icon-button","","aria-label","Toggle Highlight","matTooltip","Toggle highlight function",1,"button_theme",3,"click"],["mat-icon-button","","aria-label","Refresh","matTooltip","Refresh tree with current geometry",1,"button_theme",3,"click"],[3,"dataSource","treeControl"],["matTreeNodePadding","",4,"matTreeNodeDef"],["matTreeNodePadding","",3,"mouseenter","mouseleave",4,"matTreeNodeDef","matTreeNodeDefWhen"],["matTreeNodePadding",""],["mat-icon-button","","disabled",""],["mat-icon-button","",3,"click"],["matTreeNodePadding","",3,"mouseenter","mouseleave"],["mat-icon-button","","matTreeNodeToggle",""],[1,"mat-icon-rtl-mirror"]],template:function(c,r){1&c&&(t.j41(0,"div",0)(1,"button",1),t.bIt("click",function(){return r.toggleHighlighting()}),t.j41(2,"mat-icon"),t.EFF(3),t.k0s()(),t.j41(4,"button",2),t.bIt("click",function(){return r.refreshScheneTree()}),t.j41(5,"mat-icon"),t.EFF(6,"refresh"),t.k0s()()(),t.j41(7,"mat-tree",3),t.DNE(8,x,6,2,"mat-tree-node",4)(9,u,8,4,"mat-tree-node",5),t.k0s()),2&c&&(t.R7$(3),t.JRh(r.isHighlightingEnabled?"highlight_off":"highlight"),t.R7$(4),t.Y8G("dataSource",r.dataSource)("treeControl",r.treeControl),t.R7$(2),t.Y8G("matTreeNodeDefWhen",r.hasChild))},dependencies:[b.lQ,b.d6,R.iY,b.pO,b.yI,_.An,b.yF,s.oV],styles:[".header[_ngcontent-%COMP%]{display:flex;justify-content:flex-end}.header[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:48px;height:48px;min-width:48px;padding-top:8px}.button_theme[_ngcontent-%COMP%]{background-color:var(--background-color);color:var(--text-color);transition:background-color .3s,color .3s}.button_theme[_ngcontent-%COMP%]:hover{background-color:var(--secondary-background-color);color:var(--accent-color)}.mat-tree[_ngcontent-%COMP%]{background-color:transparent!important}"]})}}return N})()},1632:($,C,l)=>{l.d(C,{Ns:()=>z,Ab:()=>Y});var b=l(467),E=l(5304),_=l(6168);function R(e,a,o=0,i=0,g="",h){const d=e.fName,f=void 0===e.fMasterVolume?e.fVolume:e.fMasterVolume,k=f?f.fNodes:null,m=g?`${g}/${d}`:d;let V=1,G=!0;if((!h||(0,_.T)(m,h))&&a&&(G=a(e,m,i),!G))return V;if(f&&k&&i<o)for(let M=0;M<k.arr.length;M++){const U=k.arr[M];U&&(V+=R(U,a,o,i+1,m,h))}return V}function v(e,a,o=1/0){let i=function S(e,a,o=1/0){let i=[];return R(e,(h,d,f)=>(i.push({geoNode:h,fullPath:d}),!0),o,0,"",a),i}(e,a,o);if(null==i)return null;if(i.length>1)throw new Error(`findSingleGeoNode of ${e} returned more than 1 result (${i.length})`);return 0==i.length?null:i[0].geoNode}function t(e,a=1){let o=[];return R(e,(g,h,d)=>d!=a||(o.push({geoNode:g,fullPath:h}),!1),a),o}function I(){return(I=(0,b.A)(function*(e){for(const a of e.fKeys)if("TGeoManager"===a.fClassName)return e.readObject(a.fName);return null})).apply(this,arguments)}var x=l(4491),u=function(e){return e[e.kVisOverride=1]="kVisOverride",e[e.kVisNone=2]="kVisNone",e[e.kVisThis=4]="kVisThis",e[e.kVisDaughters=8]="kVisDaughters",e[e.kVisOneLevel=16]="kVisOneLevel",e[e.kVisStreamed=32]="kVisStreamed",e[e.kVisTouched=64]="kVisTouched",e[e.kVisOnScreen=128]="kVisOnScreen",e[e.kVisContainers=4096]="kVisContainers",e[e.kVisOnly=8192]="kVisOnly",e[e.kVisBranch=16384]="kVisBranch",e[e.kVisRaytrace=32768]="kVisRaytrace",e}(u||{});function A(e,a,o){void 0!==e.fGeoAtt&&(e.fGeoAtt=o?e.fGeoAtt|a:e.fGeoAtt&~a)}function N(e,a){void 0!==e.fGeoAtt&&(e.fGeoAtt=e.fGeoAtt^16777215&a)}var n=function(e){return e[e.Nothing=0]="Nothing",e[e.Remove=1]="Remove",e[e.RemoveSiblings=2]="RemoveSiblings",e[e.RemoveChildren=3]="RemoveChildren",e[e.RemoveBySubLevel=4]="RemoveBySubLevel",e[e.SetGeoBit=5]="SetGeoBit",e[e.UnsetGeoBit=6]="UnsetGeoBit",e[e.ToggleGeoBit=7]="ToggleGeoBit",e}(n||{});function r(e,a,o=1/0){let i=[],g=[...a];R(e,(d,f,k)=>{for(const m of g)if(void 0===f&&console.log("nodeFullPath == undefined"),void 0===m?.pattern&&console.log(`rule?.pattern == undefined ${m}`),(0,_.T)(f,m.pattern)){if(m.childrenRules?.length&&r(d,m.childrenRules,m.childrenRulesMaxLevel??1/0),m.action===n.Remove)return p(d),!1;if(m.action===n.RemoveChildren)return F(d),!1;(m.action===n.RemoveSiblings||m.action===n.RemoveBySubLevel)&&i.push({node:d,fullPath:f,rule:m}),m.action===n.SetGeoBit&&void 0!==m.geoBit&&A(d.fVolume,m.geoBit,1),m.action===n.UnsetGeoBit&&void 0!==m.geoBit&&A(d.fVolume,m.geoBit,0),m.action===n.ToggleGeoBit&&void 0!==m.geoBit&&N(d.fVolume,m.geoBit)}return!0},o);for(let d of i){let f=d.node,k=f.fullPath,m=d.rule,V=d.node.fMother,G=V?.fNodes?.arr;if(m.action==n.RemoveSiblings&&(G?V.fNodes.arr=[f]:console.log(`Can't get an array for: ${f} at ${k}`)),m.action==n.RemoveBySubLevel){let M=t(f,m.pruneSubLevel);for(const U of M)p(U.geoNode)}}return i}function p(e){let o=e.fMother?.fNodes?.arr;if(o){const i=o.indexOf(e);-1!==i?o.splice(i,1):console.warn(`Item ${e} not found in array???`)}else console.warn(`Can't get siblings of ${e}`)}function F(e){e.fVolume?.fNodes?.arr?e.fVolume.fNodes.arr=[]:console.log(`Can't get child nodes of ${e}`)}class W{constructor(){this.removeDetectorNames=["Lumi","B1","B2","Q2","ForwardOffM","Forward","Backward","Vacuum","SweeperMag","AnalyzerMag","ZDC","HcalFarForward","InnerTrackingSupport"],this.subDetectorsRules=[{namePattern:"*/EcalBarrelScFi*",editRules:[{pattern:"*/fiber_grid*",action:n.Remove},{pattern:"*",action:n.SetGeoBit,geoBit:u.kVisDaughters},{pattern:"*/*layer*",action:n.SetGeoBit,geoBit:u.kVisThis},{pattern:"*/*layer*",action:n.UnsetGeoBit,geoBit:u.kVisNone},{pattern:"*/*layer*",action:n.UnsetGeoBit,geoBit:u.kVisDaughters}]},{namePattern:"*/EcalBarrelImaging*",editRules:[{pattern:"*/stav*",action:n.RemoveChildren},{pattern:"*",action:n.SetGeoBit,geoBit:u.kVisDaughters}]},{namePattern:"*/DRICH*",editRules:[{pattern:"*/DRICH_cooling*",action:n.RemoveSiblings}]},{namePattern:"*/DIRC*",editRules:[{pattern:"*/Envelope_box*",action:n.RemoveChildren},{pattern:"*/Envelope_box*",action:n.SetGeoBit,geoBit:u.kVisThis},{pattern:"*/Envelope_box*",action:n.UnsetGeoBit,geoBit:u.kVisNone},{pattern:"*/Envelope_box*",action:n.UnsetGeoBit,geoBit:u.kVisDaughters},{pattern:"*/Envelope_lens_vol*",action:n.Remove}]},{namePattern:"*/EcalEndcapN*",editRules:[{pattern:"*/crystal*",action:n.RemoveSiblings}]},{namePattern:"*/EcalEndcapP_*",editRules:[{pattern:"*/EcalEndcapP_layer1_0*",action:n.UnsetGeoBit,geoBit:u.kVisDaughters},{pattern:"*/EcalEndcapP_layer1_0*",action:n.RemoveChildren}]},{namePattern:"*/LFHCAL_*",editRules:[{pattern:"*/LFHCAL_8M*",action:n.RemoveChildren},{pattern:"*/LFHCAL_8M*",action:n.SetGeoBit,geoBit:u.kVisThis},{pattern:"*/LFHCAL_8M*",action:n.UnsetGeoBit,geoBit:u.kVisNone},{pattern:"*/LFHCAL_8M*",action:n.UnsetGeoBit,geoBit:u.kVisDaughters}]},{namePattern:"*/HcalEndcapPInsert_23*",editRules:[{pattern:"*/*layer*slice1_*",action:n.RemoveSiblings}]},{namePattern:"*/HcalBarrel*",editRules:[{pattern:"*/Tile*",action:n.Remove},{pattern:"*/ChimneyTile*",action:n.Remove}]},{namePattern:"*/EndcapTOF*",editRules:[{pattern:"*/suppbar*",action:n.Remove},{pattern:"*/component*3",action:n.RemoveSiblings}]}]}process(a){let o=function j(e,a){const i=(void 0===e.fMasterVolume?e.fVolume:e.fMasterVolume)?.fNodes?.arr??[];let g=[];if(!i.length)return{nodes:i,removedNodes:g};for(let h of i)a.some(f=>h.fName.startsWith(f))&&g.push(h);for(let h of g)p(h);return{nodes:i,removedNodes:g}}(a,this.removeDetectorNames);console.log("Filtered top level detectors: ",o);for(let i of this.subDetectorsRules){let g=v(a,i.namePattern,1);if(console.log(`Processing ${g}`),g){console.time(`Process sub-detector: ${i.namePattern}`);for(let h of i.editRules)r(g,[h]);console.timeEnd(`Process sub-detector: ${i.namePattern}`)}}console.log(`Done processing ${this.subDetectorsRules.length} detectors`)}}var w=l(4438),K=l(7660),Q=l(3167);const T="Calorimeters",P="Tracking",O="PID",y="Magnets",B="Beam pipe and support",z=[T,P,O,y,B];let Y=(()=>{class e{constructor(o,i){this.settings=o,this.urlService=i,this.rootGeometryProcessor=new W,this.subdetectors=[],this.rootGeometry=null,this.geometry=null,this.groupsByDetName=new Map([["SolenoidBarrel_assembly_0",y],["SolenoidEndcapP_1",y],["SolenoidEndcapN_2",y],["VertexBarrelSubAssembly_3",P],["InnerSiTrackerSubAssembly_4",P],["MiddleSiTrackerSubAssembly_5",P],["OuterSiTrackerSubAssembly_6",P],["EndcapMPGDSubAssembly_7",P],["InnerMPGDBarrelSubAssembly_8",P],["EndcapTOFSubAssembly_9",O],["BarrelTOFSubAssembly_10",O],["OuterBarrelMPGDSubAssembly_11",P],["B0TrackerSubAssembly_12",P],["InnerTrackerSupport_assembly_13",B],["DIRC_14",O],["RICHEndcapN_Vol_15",O],["DRICH_16",O],["EcalEndcapP_17",T],["EcalEndcapPInsert_18",T],["EcalBarrelImaging_19",T],["EcalBarrelScFi_20",T],["EcalEndcapN_21",T],["LFHCAL_env_22",T],["HcalEndcapPInsert_23",T],["HcalBarrel_24",T],["FluxBarrel_env_25",B],["FluxEndcapP_26",B],["HcalEndcapN_27",T],["FluxEndcapN_28",B],["BeamPipe_assembly_29",B],["B0PF_BeamlineMagnet_assembly_30",y],["B0APF_BeamlineMagnet_assembly_31",y],["Q1APF_BeamlineMagnet_assembly_32",y],["Q1BPF_BeamlineMagnet_assembly_33",y],["BeamPipeB0_assembly_38",B],["Pipe_cen_to_pos_assembly_39",B],["Q0EF_assembly_40",y],["Q0EF_vac_41",y],["Q1EF_assembly_42",y],["Q1EF_vac_43",y],["B0ECal_44",T],["Pipe_Q1eR_to_B2BeR_assembly_54",B],["Magnet_Q1eR_assembly_55",y],["Magnet_Q2eR_assembly_56",y],["Magnet_B2AeR_assembly_57",y],["Magnet_B2BeR_assembly_58",y],["Magnets_Q3eR_assembly_59",y]])}loadGeometry(){var o=this;return(0,b.A)(function*(){o.subdetectors=[];let i="builtin://epic-central-optimized"!==o.settings.selectedGeometry.value?o.settings.selectedGeometry.value:"https://eic.github.io/epic/artifacts/tgeo/epic_full.root";i=o.urlService.resolveDownloadUrl(i),console.time("[GeometryService]: Total load geometry time"),console.log(`[GeometryService]: Loading file ${i}`),console.time("[GeometryService]: Open root file");const g=yield(0,E.TqT)(i);if(console.timeEnd("[GeometryService]: Open root file"),console.time("[GeometryService]: Reading geometry from file"),o.rootGeometry=yield function D(e){return I.apply(this,arguments)}(g),console.log("Got TGeoManager. For inspection:"),console.log(o.rootGeometry),console.timeEnd("[GeometryService]: Reading geometry from file"),console.time("[GeometryService]: Root geometry pre-processing"),o.rootGeometryProcessor.process(o.rootGeometry),console.time("[GeometryService]: Root geometry pre-processing"),function s(e,a=2){let o=t(e,1),i=0;console.log(`--- Detector subcomponents analysis --- Detectors: ${o.length}`);for(let g of o){let h=R(g.geoNode,null,1/0);i+=h,console.log(`${h}: ${g.fullPath}`)}console.log(`--- End of analysis --- Total elements: ${i}`)}(o.rootGeometry,1),console.time("[GeometryService]: Build geometry"),o.geometry=(0,x.build)(o.rootGeometry,{numfaces:5e9,numnodes:5e9,instancing:-1,dflt_colors:!1,vislevel:200,doubleside:!0,transparency:!0}),console.timeEnd("[GeometryService]: Build geometry"),!o.geometry)throw new Error("Geometry is null or undefined after TGeoPainter.build");if(!o.geometry.children.length)throw new Error("Geometry is converted but empty. Anticipated 'world_volume' but got nothing");if(!o.geometry.children[0].children.length)throw new Error("Geometry is converted but empty. Anticipated array of top level nodes (usually subdetectors) but got nothing");console.time("[GeometryService]: Map root geometry to threejs geometry");let h=o.geometry.children[0].children;for(const d of h){const f=d.name,V=(o.stripIdFromName(f),t(o.rootGeometry,1).map(M=>M.geoNode).find(M=>M.fName===f));let G={sourceGeometry:V,sourceGeometryName:V?.fName??"",geometry:d,name:o.stripIdFromName(f),groupName:o.groupsByDetName.get(f)||""};console.log(G.sourceGeometryName),o.subdetectors.push(G)}return console.timeEnd("[GeometryService]: Map root geometry to threejs geometry"),console.timeEnd("[GeometryService]: Total load geometry time"),{rootGeometry:o.rootGeometry,threeGeometry:o.geometry}})()}stripIdFromName(o){return o.replace(/_\d+$/,"")}toggleVisibility(o){o&&(o.visible=!o.visible,console.log(`Visibility toggled for object: ${o.name}. Now visible: ${o.visible}`))}static{this.\u0275fac=function(i){return new(i||e)(w.KVO(K.B),w.KVO(Q.H))}}static{this.\u0275prov=w.jDH({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})()},3167:($,C,l)=>{l.d(C,{H:()=>R});var b=l(4438),E=l(7660),_=l(5383);let R=(()=>{class S{constructor(s,t){this.userConfigService=s,this.serverConfigService=t,this.serverAddress="",this.isBackendAvailable=!1,this.protocolAliases={"epic://":"https://eic.github.io/epic/artifacts/"},this.initializeConfig()}initializeConfig(){this.updateServerConfig(),this.userConfigService.localServerUrl.subject.subscribe(()=>{this.updateServerConfig()}),this.userConfigService.localServerUseApi.subject.subscribe(()=>{this.updateServerConfig()})}updateServerConfig(){const s=this.serverConfigService.config.servedByPyrobird,t=this.userConfigService.localServerUseApi.value,D=this.userConfigService.localServerUrl.value;this.isBackendAvailable=s||t,this.serverAddress=s?this.serverConfigService.config.apiBaseUrl:t?D:""}resolveProtocolAliases(s){if(s.startsWith("asset://")){const t=s.substring(8);return`${document.baseURI.endsWith("/")?document.baseURI:`${document.baseURI}/`}assets/${t}`}for(const t in this.protocolAliases)if(s.startsWith(t))return s.replace(t,this.protocolAliases[t]);return s}isAbsoluteUrl(s){return/^[a-z][a-z0-9+.-]*:/.test(s)}resolveDownloadUrl(s){return s=this.resolveProtocolAliases(s),this.isAbsoluteUrl(s)?s:this.isBackendAvailable&&this.serverAddress?`${this.serverAddress}/api/v1/download?f=${encodeURIComponent(s)}`:(console.warn("Backend is not available to fetch the file"),s)}resolveConvertUrl(s,t,D){return s=this.resolveProtocolAliases(s),this.isBackendAvailable&&this.serverAddress?`${this.serverAddress}/api/v1/convert/${t}/${D}?f=${encodeURIComponent(s)}`:(console.warn("Backend is not available to perform conversion"),s)}static{this.\u0275fac=function(t){return new(t||S)(b.KVO(E.B),b.KVO(_.B))}}static{this.\u0275prov=b.jDH({token:S,factory:S.\u0275fac,providedIn:"root"})}}return S})()},3137:($,C,l)=>{l.d(C,{c:()=>b});class b{get phoenixThreeManager(){return this.phoenixEventDisplay.getThreeManager()}get activeOrbitControls(){return this.phoenixThreeManager.controlsManager.getActiveControls()}get mainCamera(){return this.phoenixThreeManager.controlsManager.getMainCamera()}get activeCamera(){return this.phoenixThreeManager.controlsManager.getActiveCamera()}get scene(){return this.phoenixThreeManager.getSceneManager().getScene()}get sceneGeometries(){return this.phoenixThreeManager.getSceneManager().getGeometries()}get mainRenderer(){return this.phoenixThreeManager.rendererManager.getMainRenderer()}get sceneEvent(){return this.phoenixThreeManager.getSceneManager().getEventData()}constructor(_){this.phoenixEventDisplay=_}}},6168:($,C,l)=>{function b(E,_){let R=0,S=0,v=0,s=0;for(;s<E.length&&"*"!==_[v];){if(_[v]!==E[s]&&"?"!==_[v])return!1;v++,s++}for(;s<E.length;)if("*"===_[v]){if(++v===_.length)return!0;S=v,R=s+1}else if(_[v]===E[s]||"?"===_[v])v++,s++;else{if(R>E.length)return!1;v=S,s=R++}for(;v<_.length&&"*"===_[v];)v++;return v===_.length}l.d(C,{T:()=>b})}}]);